<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background-color: #f8fbff;
        min-height: 100vh;
    }

    .container {
        max-width: 100%;
        margin: 0 auto;
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 100, 200, 0.1);
        border: 1px solid #e3f2fd;
    }

    .header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #1976d2 0%, #4caf50 100%);
        color: white;
        border-radius: 8px;
        margin: -15px -15px 20px -15px;
    }

    .logo {
        font-size: 24px;
        font-weight: bold;
        color: white;
        text-align: center;
    }

    .customer-info {
        text-align: center;
    }

    .customer-info p {
        margin: 5px 0;
        color: #e1f5fe;
    }

    .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .cart-icon {
        position: relative;
        background: none;
        color: #1976d2;
        border: none;
        cursor: pointer;
        font-size: 24px;
        padding: 8px;
        transition: transform 0.2s;
        text-decoration: none;
        display: inline-block;
    }

    .cart-icon:hover {
        transform: translateY(-2px);
    }

    .cart-badge {
        position: absolute;
        top: 0;
        right: 0;
        background: linear-gradient(135deg, #ff4444 0%, #ff7043 100%);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }

    .search-bar {
        margin: 20px 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .search-bar input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 2px solid #2196f3;
        background-color: white;
        transition: border-color 0.3s;
    }

    .search-bar input:focus {
        outline: none;
        border-color: #4caf50;
    }

    .search-bar button {
        padding: 12px 20px;
        background: linear-gradient(135deg, #2196f3 0%, #4caf50 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
        font-size: 16px;
        font-weight: bold;
    }

    .search-bar button:hover {
        transform: translateY(-2px);
    }

    #clearSearchBtn {
        background: linear-gradient(135deg, #f44336 0%, #e57373 100%);
    }

    .product-list {
        display: flex;
        flex-direction: column;
        gap: 20px; 
        margin-bottom: 30px;
    }

    .product-row {
        display: flex;
        align-items: center;
        background-color: white;
        border: 1px solid #e3f2fd;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 8px rgba(0, 100, 200, 0.1);
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }

    .product-row:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        border-color: #4caf50;
    }

    .product-row.in-cart {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
        animation: highlight 0.5s ease;
    }

    @keyframes highlight {
        from { background-color: #e8f5e9; }
        50% { background-color: #c8e6c9; }
        to { background-color: #e8f5e9; }
    }

    .product-details {
        flex-grow: 1;
    }

    .product-name {
        font-size: 16px;
        font-weight: 500;
        color: #1976d2;
        margin-bottom: 5px;
    }

    .product-description {
        font-size: 14px;
        color: #555;
        margin-bottom: 5px;
    }

    .product-specs {
        font-size: 13px;
        color: #777;
        margin-bottom: 10px;
    }

    .product-price {
        font-size: 18px;
        font-weight: bold;
        color: #4caf50;
    }

    .product-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .quantity-controls button {
        width: 30px;
        height: 30px;
        border: 2px solid #2196f3;
        background-color: white;
        color: #2196f3;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.2s;
    }

    .quantity-controls button:hover {
        background: linear-gradient(135deg, #2196f3 0%, #4caf50 100%);
        color: white;
        border-color: #4caf50;
    }

    .quantity-controls button:disabled {
        border-color: #ccc;
        color: #ccc;
        cursor: not-allowed;
    }

    .quantity-display {
        background: linear-gradient(135deg, #f3f9ff 0%, #e8f8f5 100%);
        padding: 5px 10px;
        border-radius: 8px;
        font-weight: bold;
        min-width: 50px;
        text-align: center;
        color: #1976d2;
        border: 2px solid #2196f3;
        font-size: 14px;
        cursor: pointer;
    }

    .quantity-input {
        background: linear-gradient(135deg, #f3f9ff 0%, #e8f8f5 100%);
        padding: 5px 10px;
        border-radius: 8px;
        font-weight: bold;
        width: 70px;
        text-align: center;
        color: #1976d2;
        border: 2px solid #2196f3;
        font-size: 14px;
        outline: none;
    }

    .add-to-cart-btn {
        padding: 8px;
        background: linear-gradient(135deg, #ff5722 0%, #8f2808 100%);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.2s;
        box-shadow: 0 2px 6px rgba(255, 87, 34, 0.3);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .add-to-cart-btn::after {
        content: "🛒";
    }

    .add-to-cart-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4);
    }

    .add-to-cart-btn:disabled {
        background: linear-gradient(135deg, #ccc 0%, #ddd 100%);
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        opacity: 0.5;
    }

    .success-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        animation: slideIn 0.3s ease-out;
        text-align: center;
        max-width: 90%;
    }

    @keyframes slideIn {
        from {
            transform: translateX(-50%) translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Mobile Responsiveness */
    @media only screen and (max-width: 768px) {
        body {
            padding: 5px;
        }
        
        .container {
            padding: 10px;
        }
        
        .header {
            padding: 15px;
            margin: -10px -10px 15px -10px;
        }
        
        .logo {
            font-size: 20px;
        }
        
        .product-row {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px;
        }
        
        .product-actions {
            width: 100%;
            justify-content: center;
            margin-top: 10px;
            flex-direction: row;
        }
        
        .product-name {
            font-size: 15px;
        }
        
        .product-price {
            font-size: 16px;
        }
        
        .quantity-controls button {
            width: 28px;
            height: 28px;
            font-size: 13px;
        }
        
        .quantity-display, .quantity-input {
            font-size: 13px;
            min-width: 70px;
        }

        .add-to-cart-btn {
            width: 32px;
            height: 32px;
            font-size: 12px;
        }
    }

    @media only screen and (min-width: 769px) {
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        
        .customer-info {
            text-align: right;
        }
        
        .search-bar {
            flex-direction: row;
            gap: 10px;
        }
        
        .search-bar input {
            flex: 1;
        }
        
        .search-bar button {
            min-width: 100px;
        }

        /* Desktop-specific product actions */
        .product-actions {
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .quantity-controls {
            justify-content: flex-end;
        }

        .add-to-cart-btn {
            margin-top: 5px;
            border-radius: 8px;
            width: auto;
            padding: 8px 12px;
        }

        .add-to-cart-btn::after {
            content: "Add to Cart";
        }
    }
    .in-cart-quantity {
        font-size: 13px;
        color: #4caf50;
        font-weight: bold;
        margin-top: 5px;
    }

    /* Pagination Styles */
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 5px;
    }

    .pagination button {
        padding: 8px 12px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination button:hover {
        background-color: #e0e0e0;
    }

    .pagination button.active {
        background-color: #1976d2;
        color: white;
        border-color: #1976d2;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-info {
        text-align: center;
        margin-top: 10px;
        color: #666;
        font-size: 14px;
    }
    /*  */
/* Updated Cart Header to include customer selector */
.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 15px;
}

.cart-header-left {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
}

/* Customer Dropdown Styles - Updated for cart header position */
.customer-selector {
    position: relative;
    display: inline-block;
    min-width: 200px;
    flex-shrink: 0;
}

.customer-dropdown-container {
    position: relative;
}

.customer-dropdown-container input {
    width: 100%;
    padding: 8px 35px 8px 12px;
    border: 2px solid #2196f3;
    border-radius: 6px;
    font-size: 14px;
    background-color: white;
    color: #333;
    transition: all 0.3s;
    height: 38px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.customer-dropdown-container input:focus {
    outline: none;
    border-color: #4caf50;
    box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
}

.dropdown-arrow {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #1976d2;
    font-size: 12px;
    pointer-events: auto;
    cursor: pointer;
}

.custom-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e3f2fd;
    border-radius: 0 0 6px 6px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    margin-top: -1px;
}

.custom-dropdown.show {
    display: block;
}

.dropdown-search {
    padding: 8px;
    background: white;
    position: sticky;
    top: 0;
    border-bottom: 1px solid #e3f2fd;
}

.dropdown-search input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e3f2fd;
    border-radius: 4px;
    font-size: 14px;
}

.dropdown-items-container {
    max-height: 250px;
    overflow-y: auto;
}

.dropdown-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #e3f2fd;
    transition: background-color 0.2s;
}

.dropdown-item:hover {
    background-color: #f5f5f5;
}

.dropdown-item.selected {
    background-color: #e3f2fd;
}

.customer-name {
    font-weight: 600;
    color: #1976d2;
    font-size: 14px;
}

.customer-details {
    font-size: 12px;
    color: #666;
    margin-top: 3px;
}

.no-results {
    padding: 12px;
    color: #666;
    text-align: center;
    font-style: italic;
}

/* Mobile Responsiveness */
@media only screen and (max-width: 768px) {
    .cart-header {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .cart-header-left {
        gap: 10px;
        min-width: 0;
    }
    
    .customer-selector {
        min-width: 160px;
        flex: 1;
        max-width: 200px;
    }
    
    .customer-dropdown-container input {
        font-size: 13px;
        height: 36px;
        padding: 6px 30px 6px 10px;
    }
}

@media only screen and (max-width: 480px) {
    .cart-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .cart-header-left {
        justify-content: space-between;
    }
    
    .customer-selector {
        min-width: 140px;
        max-width: none;
    }
    
    .customer-dropdown-container input {
        font-size: 12px;
        height: 34px;
    }
}
    </style>
</head>
<body>
    <div class="customer-selector">
  <div class="customer-dropdown-container">
    <input 
      type="text" 
      name="customer" 
      id="customerSelector" 
      placeholder="Select customer..." 
      required 
      autocomplete="off" 
      aria-autocomplete="list" 
      aria-controls="customerDropdown" 
      aria-expanded="false"
    />
    <div class="dropdown-arrow" onclick="toggleCustomerDropdown()" tabindex="0" role="button" aria-label="Toggle customer dropdown">▼</div>
    <div class="custom-dropdown" id="customerDropdown" role="listbox">
      <div class="dropdown-search">
        <input 
          type="text" 
          placeholder="Search customers..." 
          aria-label="Search customers"
          class="dropdown-search-input"
        />
      </div>
      <div class="dropdown-items-container">
        <!-- Items will be populated dynamically -->
      </div>
    </div>
  </div>
</div>
    <div class="container">
        <div class="header">
            <div class="logo">Order Management</div>
            <div class="customer-info">
                <p><strong>Customer Name: <span id="displayCustomerName">John Doe</span></strong></p>
                <p><span id="displayCustomerPlace"></span></p>
                <p><span id="displayCustomerPhone"></span></p>

                <!-- <p>Order ID: #ORD001</p> -->
                <p>Date: <span id="currentDate"></span></p>
            </div>
        </div>
        
        <div class="cart-header">
            <button onclick="window.history.back()" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ← Back
            </button>
            <a href="{% url 'cart' %}" class="cart-icon" style="text-decoration: none; font-size: 24px; position: relative;">
                🛒
                <span id="cartBadge" class="cart-badge" style="position: absolute; top: -8px; right: -10px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px;">
                    0
                </span>
            </a>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search Product or Enter Code (e.g., 00001)">
            <button onclick="searchProduct()">Search</button>
            <button onclick="clearSearch()" id="clearSearchBtn" style="display: none;">Clear</button>
        </div>

        <div class="product-list" id="productList">
            <div class="loading-spinner" id="loadingSpinner"></div>
        </div>

        <div class="pagination" id="pagination">
            <!-- Pagination buttons will be added here dynamically -->
        </div>

        <div class="page-info" id="pageInfo">
            <!-- Page info will be added here dynamically -->
        </div>
    </div>

    <script>
    /* ----------  Global Variables  ---------- */
    let products = [];
    let cartQuantities = {};
    let selectedQuantities = {};
    let currentPage = 1;
    const itemsPerPage = 10;
    let isSearching = false;
    let searchTerm = '';
    let customerList = [];

    /* ----------  Helper Functions  ---------- */
    function getCurrentCustomerName() {
        return JSON.parse(localStorage.getItem('selected_customer') || '{}').name || 'Guest';
    }

    function getCustomerCart() {
        const all = JSON.parse(localStorage.getItem('cartData') || '{}');
        const cust = getCurrentCustomerName();
        if (!all[cust]) all[cust] = {};
        return all[cust];
    }

    function setCustomerCart(obj) {
        const all = JSON.parse(localStorage.getItem('cartData') || '{}');
        all[getCurrentCustomerName()] = obj;
        localStorage.setItem('cartData', JSON.stringify(all));
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
    }

    function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'success-message';
        errorDiv.style.background = 'linear-gradient(135deg, #f44336 0%, #e57373 100%)';
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
    }

    /* ----------  DOM Content Loaded  ---------- */
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        
        // Load customer info
       
        fetchProducts();

        window.addEventListener('storage', handleStorageEvent);
        window.addEventListener('focus', handleWindowFocus);

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchProduct();
        });
    });
      // Initialize customer dropdown
        fetchCustomers();
        setupCustomerDropdown();

    /* ----------  Product Functions  ---------- */
    async function fetchProducts() {
        try {
            showLoading(true);
            const token = localStorage.getItem('access_token');
            if (!token) {
                showErrorMessage("Please login first");
                return;
            }

            const response = await fetch('/products/', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || "Server returned an error");
            }

            const data = await response.json();
            products = (data.results || []).map(p => ({
                ...p,
                displayPrice: p.batch?.salesprice ?? p.batch?.bmrp ?? 0
            }));

            products.forEach(product => {
                if (!product.code) return;
                cartQuantities[product.code] = cartQuantities[product.code] || 0;
                selectedQuantities[product.code] = selectedQuantities[product.code] || 0;
            });

            loadCartFromLocalStorage();
            loadProducts();
            updateCartBadge();
            setupPagination();

        } catch (error) {
            console.error("Fetch error:", error);
            products = [];
            showErrorMessage(error.message || "Failed to load products");
            document.getElementById('productList').innerHTML =
                '<div style="text-align: center; padding: 20px; color: #666;">' +
                (error.message || "Failed to load products. Please try again.") +
                '</div>';
        } finally {
            showLoading(false);
        }
    }

    function loadCartFromLocalStorage() {
        const saved = getCustomerCart();
        cartQuantities = {...saved};
        Object.keys(saved).forEach(code => {
            selectedQuantities[code] = saved[code];
        });
        updateCartBadge();
        updateProductHighlights();
    }

    function saveCartToLocalStorage() {
        setCustomerCart(cartQuantities);
        window.dispatchEvent(new StorageEvent('storage', {
            key: 'cartData',
            newValue: JSON.stringify(cartQuantities)
        }));
    }

    function handleStorageEvent(e) {
        if (e.key === 'cartData') {
            loadCartFromLocalStorage();
            updateCartBadge();
            updateProductHighlights();
            loadProducts();
        }
    }

    function handleWindowFocus() {
        loadCartFromLocalStorage();
        updateCartBadge();
        updateProductHighlights();
        loadProducts();
    }

    /* ----------  Product Display Functions  ---------- */
    function loadProducts() {
        const productList = document.getElementById('productList');
        productList.innerHTML = '';

        if (!Array.isArray(products)) {
            console.error("Products data is not an array!");
            products = [];
        }

        if (products.length === 0) {
            productList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No products available</div>';
            return;
        }

        let productsToDisplay = products;

        if (isSearching && searchTerm) {
            productsToDisplay = products.filter(product =>
                (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                (product.code && product.code.toLowerCase().includes(searchTerm)) ||
                (product.brand && product.brand.toLowerCase().includes(searchTerm)) ||
                (product.product && product.product.toLowerCase().includes(searchTerm))
            );
        }

        if (productsToDisplay.length === 0) {
            productList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No products found</div>';
            document.getElementById('pagination').innerHTML = '';
            document.getElementById('pageInfo').innerHTML = '';
            return;
        }

        let paginatedProducts = productsToDisplay;
        if (!isSearching) {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, productsToDisplay.length);
            paginatedProducts = productsToDisplay.slice(startIndex, endIndex);
        }

        paginatedProducts.forEach(product => {
            if (!product.code) return;

            const productRow = document.createElement('div');
            productRow.className = 'product-row';
            productRow.id = `product-${product.code}`;

            if (cartQuantities[product.code] > 0) {
                productRow.classList.add('in-cart');
            }

            let description = '';
            if (product.product) description += product.product;
            if (product.brand) description += (description ? ' - ' : '') + product.brand;
            if (product.unit) description += (description ? ' ' : '') + product.unit;

            productRow.innerHTML = `
                <div class="product-details">
                    <div class="product-name">${escapeHtml(product.name || '')}</div>
                    <div class="product-description">${escapeHtml(description)}</div>
                    <div class="product-specs">Code: ${escapeHtml(product.code || '')}</div>
                    <div class="product-price">₹${(product.displayPrice || 0).toLocaleString()}</div>
                    <div class="in-cart-quantity" id="in-cart-${product.code}" 
                        style="${cartQuantities[product.code] > 0 ? '' : 'display: none;'}">
                        In cart: ${cartQuantities[product.code]}
                    </div>
                </div>
                <div class="product-actions">
                    <div class="quantity-controls">
                        <button onclick="changeSelectedQuantity('${product.code}', -1)" ${selectedQuantities[product.code] <= 0 ? 'disabled' : ''}>-</button>
                        <div class="quantity-display" id="qty-${product.code}" onclick="enableQuantityInput('${product.code}')">${selectedQuantities[product.code] || 0}</div>
                        <button onclick="changeSelectedQuantity('${product.code}', 1)">+</button>
                    </div>
                    <button class="add-to-cart-btn" onclick="addToCart('${product.code}')" 
                            ${selectedQuantities[product.code] <= 0 ? 'disabled' : ''}
                            title="Add ${selectedQuantities[product.code]} to Cart">
                    </button>
                </div>
            `;
            productList.appendChild(productRow);
        });

        if (isSearching) {
            document.getElementById('pagination').innerHTML = '';
            document.getElementById('pageInfo').innerHTML = `Showing ${productsToDisplay.length} search results`;
        } else {
            setupPagination();
            updatePageInfo();
        }
    }

    /* ----------  Quantity Functions  ---------- */
    function enableQuantityInput(productCode) {
        const qtyElement = document.getElementById(`qty-${productCode}`);
        if (!qtyElement) return;

        const currentValue = selectedQuantities[productCode];
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'quantity-input';
        input.value = currentValue;
        input.min = '0';
        input.onblur = function() {
            updateQuantityFromInput(productCode, this);
        };
        input.onkeypress = function(e) {
            if (e.key === 'Enter') {
                updateQuantityFromInput(productCode, this);
            }
        };

        qtyElement.replaceWith(input);
        input.focus();
        input.select();
    }

    function updateQuantityFromInput(productCode, inputElement) {
        const newValue = parseInt(inputElement.value) || 0;
        if (newValue >= 0) {
            selectedQuantities[productCode] = newValue;
            const displayElement = document.createElement('div');
            displayElement.className = 'quantity-display';
            displayElement.id = `qty-${productCode}`;
            displayElement.textContent = newValue;
            displayElement.onclick = function() {
                enableQuantityInput(productCode);
            };
            inputElement.replaceWith(displayElement);
            updateQuantityButtons(productCode);
            updateAddToCartButton(productCode);
        }
    }

    function changeSelectedQuantity(productCode, change) {
        const newQuantity = selectedQuantities[productCode] + change;
        if (newQuantity >= 0) {
            selectedQuantities[productCode] = newQuantity;
            updateQuantityDisplay(productCode);
            updateQuantityButtons(productCode);
            updateAddToCartButton(productCode);
        }
    }

    function updateQuantityDisplay(productCode) {
        const qtyElement = document.getElementById(`qty-${productCode}`);
        if (qtyElement) qtyElement.textContent = selectedQuantities[productCode];
    }

    function updateQuantityButtons(productCode) {
        const productRow = document.getElementById(`product-${productCode}`);
        if (productRow) {
            const decreaseBtn = productRow.querySelector('.quantity-controls button');
            if (decreaseBtn) decreaseBtn.disabled = selectedQuantities[productCode] <= 0;
        }
    }

    function updateAddToCartButton(productCode) {
        const productRow = document.getElementById(`product-${productCode}`);
        if (productRow) {
            const addBtn = productRow.querySelector('.add-to-cart-btn');
            if (addBtn) {
                addBtn.disabled = selectedQuantities[productCode] <= 0;
                addBtn.title = `Add ${selectedQuantities[productCode]} to Cart`;
            }
        }
    }

    /* ----------  Cart Functions  ---------- */
    function addToCart(productCode) {
    const qty = selectedQuantities[productCode] || 1;

    // If product already in cart, update only if quantity changed
    if (cartQuantities[productCode]) {
        if (qty !== cartQuantities[productCode]) {
            cartQuantities[productCode] = qty;
        }
    } else {
        // New product → set quantity
        cartQuantities[productCode] = qty;
    }

    const product = products.find(p => p.code === productCode);
    showSuccessMessage(`${product.name} added (${cartQuantities[productCode]} total)`);

    selectedQuantities[productCode] = 0;
    updateQuantityDisplay(productCode);
    updateQuantityButtons(productCode);
    updateAddToCartButton(productCode);
    updateCartBadge();
    updateProductHighlights();

    const inCartEl = document.getElementById(`in-cart-${productCode}`);
    if (inCartEl) {
        inCartEl.textContent = `In cart: ${cartQuantities[productCode]}`;
        inCartEl.style.display = 'block';
    }
    saveCartToLocalStorage();
}


    function updateCartBadge() {
        const cartBadge = document.getElementById('cartBadge');
        const totalItems = Object.values(cartQuantities).reduce((sum, qty) => sum + qty, 0);
        cartBadge.textContent = totalItems;
    }

    function updateProductHighlights() {
        products.forEach(product => {
            if (!product.code) return;
            const productRow = document.getElementById(`product-${product.code}`);
            if (productRow) {
                productRow.classList.toggle('in-cart', cartQuantities[product.code] > 0);
            }
        });
    }

    function clearCart() {
        products.forEach(product => {
            if (product.code) {
                cartQuantities[product.code] = 0;
                selectedQuantities[product.code] = 0;
            }
        });
        setCustomerCart({});
        updateCartBadge();
        updateProductHighlights();
        loadProducts();
    }

    /* ----------  Search Functions  ---------- */
    function searchProduct() {
        searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        document.getElementById('clearSearchBtn').style.display = searchTerm ? 'block' : 'none';
        if (!searchTerm) {
            clearSearch();
            return;
        }
        isSearching = true;
        loadProducts();
    }

    function clearSearch() {
        searchTerm = '';
        isSearching = false;
        document.getElementById('searchInput').value = '';
        document.getElementById('clearSearchBtn').style.display = 'none';
        currentPage = 1;
        loadProducts();
        setupPagination();
    }

    /* ----------  Pagination Functions  ---------- */
    function setupPagination() {
        const paginationDiv = document.getElementById('pagination');
        paginationDiv.innerHTML = '';

        if (products.length <= itemsPerPage) return;

        const totalPages = Math.ceil(products.length / itemsPerPage);
        const maxVisibleButtons = 5;
        let startPage, endPage;

        if (totalPages <= maxVisibleButtons) {
            startPage = 1;
            endPage = totalPages;
        } else {
            const maxBefore = Math.floor(maxVisibleButtons / 2);
            const maxAfter = Math.ceil(maxVisibleButtons / 2) - 1;
            if (currentPage <= maxBefore) {
                startPage = 1;
                endPage = maxVisibleButtons;
            } else if (currentPage + maxAfter >= totalPages) {
                startPage = totalPages - maxVisibleButtons + 1;
                endPage = totalPages;
            } else {
                startPage = currentPage - maxBefore;
                endPage = currentPage + maxAfter;
            }
        }

        const prevButton = document.createElement('button');
        prevButton.innerHTML = '&laquo;';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                loadProducts();
                setupPagination();
            }
        };
        paginationDiv.appendChild(prevButton);

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i;
            if (i === currentPage) pageButton.classList.add('active');
            pageButton.onclick = () => {
                currentPage = i;
                loadProducts();
                setupPagination();
            };
            paginationDiv.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.innerHTML = '&raquo;';
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadProducts();
                setupPagination();
            }
        };
        paginationDiv.appendChild(nextButton);
    }

    function updatePageInfo() {
        const pageInfoDiv = document.getElementById('pageInfo');
        if (products.length <= itemsPerPage) {
            pageInfoDiv.innerHTML = `Showing all ${products.length} items`;
        } else {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, products.length);
            pageInfoDiv.innerHTML = `Showing items ${startIndex} to ${endIndex} of ${products.length}`;
        }
    }
    function toggleCustomerDropdown(force = null) {
  const dropdown = document.getElementById('customerDropdown');
  const arrow = document.querySelector('.dropdown-arrow');
  const input = document.getElementById('customerSelector');

  const open = force === null ? dropdown.style.display !== 'block' : force;
  dropdown.style.display = open ? 'block' : 'none';
  arrow.classList.toggle('open', open);
  input.setAttribute('aria-expanded', open);
  
  if (open) {
    document.querySelector('.dropdown-search input').focus();
  }
}

function selectCustomer(customer) {
  document.getElementById('customerSelector').value = customer.name;
  document.getElementById('displayCustomerName').textContent = customer.name;
  document.getElementById('displayCustomerPlace').textContent = customer.address || '';
  document.getElementById('displayCustomerPhone').textContent = customer.phone || '';
  toggleCustomerDropdown(false);
  
  // Save to localStorage
  localStorage.setItem('selected_customer', JSON.stringify({
    name: customer.name,
    place: customer.address,
    phone: customer.phone
  }));
}

async function fetchCustomers() {
  try {
    const token = localStorage.getItem('access_token');
    const response = await fetch('/customers/', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (response.ok) {
      customerList = await response.json();
      populateCustomerDropdown(customerList);
    }
  } catch (error) {
    console.error('Error fetching customers:', error);
  }
}

function populateCustomerDropdown(customers) {
  const container = document.querySelector('.dropdown-items-container');
  container.innerHTML = '';

  if (customers.length === 0) {
    container.innerHTML = '<div class="no-results">No customers found</div>';
    return;
  }

  customers.forEach(customer => {
    const item = document.createElement('div');
    item.className = 'dropdown-item';
    item.setAttribute('role', 'option');
    item.setAttribute('tabindex', '0');
    item.innerHTML = `<div class="customer-name">${customer.name}</div>`;
    
    item.addEventListener('click', () => selectCustomer(customer));
    item.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        selectCustomer(customer);
      }
    });
    
    container.appendChild(item);
  });
}

function setupCustomerDropdown() {
  // Handle input in main search field
  document.getElementById('customerSelector').addEventListener('input', function(e) {
    const keyword = e.target.value.toLowerCase();
    const filtered = customerList.filter(c => 
      c.name.toLowerCase().includes(keyword) || 
      (c.phone && c.phone.toLowerCase().includes(keyword))
    );
    populateCustomerDropdown(filtered);
    toggleCustomerDropdown(true);
  });

  // Handle search inside dropdown
  document.querySelector('.dropdown-search input').addEventListener('input', function(e) {
    const keyword = e.target.value.toLowerCase();
    const filtered = customerList.filter(c => 
      c.name.toLowerCase().includes(keyword) || 
      (c.phone && c.phone.toLowerCase().includes(keyword))
    );
    populateCustomerDropdown(filtered);
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', e => {
    const container = document.querySelector('.customer-dropdown-container');
    if (!container.contains(e.target)) toggleCustomerDropdown(false);
  });

  // Close on Escape
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') toggleCustomerDropdown(false);
  });
}
</script>
</body>
</html>