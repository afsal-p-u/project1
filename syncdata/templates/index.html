<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Dashboard Overview</title>
    <style>
/* ================== RESET & BASE ================== */
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background:linear-gradient(135deg,#f5f3ff 0%,#ddd6fe 100%);
  min-height:100vh;
  padding:20px;
  -webkit-tap-highlight-color:transparent;
  -webkit-touch-callout:none;
}
.container{
  max-width:1400px;margin:0 auto;background:rgba(255,255,255,.98);
  border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden;
  backdrop-filter:blur(10px);
}

/* ================== HEADER ================== */
.header{
  background:linear-gradient(135deg,#1e40af 0%,#2563eb 100%);
  color:#fff;padding:20px;position:relative;overflow:hidden;
}
.header::before{
  content:"";position:absolute;inset:0;pointer-events:none;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
  opacity:.3
}
.header-content{
  position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:15px;width:100%;
}
.welcome-text{text-align:center}
@keyframes textGlow{from{text-shadow:0 0 5px rgba(255,255,255,.5)}to{text-shadow:0 0 15px rgba(255,255,255,.8)}}
.welcome-text h2{
  margin:0;font-size:24px;font-weight:700;animation:textGlow 2s ease-in-out infinite alternate;
  background:linear-gradient(to right,#fff,#e0e7ff);-webkit-background-clip:text;background-clip:text;color:transparent
}
.user-info{text-align:center;animation:fadeIn 1s ease-out .5s both;order:1}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.user-info p{margin:0;font-size:14px;color:#e0e7ff}
.header-actions{display:flex;justify-content:center;order:3;width:100%}
.logout-button{
  padding:10px 20px;background:#e63946;color:#fff;border:0;border-radius:6px;font-size:16px;cursor:pointer;
  transition:background-color .3s ease;width:100%;max-width:120px
}
.logout-button:hover{background:#d62828}
.logout-button:active{background:#b71c1c}

/* ================== MAIN ================== */
.main-content{padding:20px;position:relative}

/* ======== DATE FILTER (in header band) ======== */
.content-header{
  position:absolute; /* let the date card float at the top-right of main content */
  right:24px;
  top:-12px;         /* LIFTED a little more as you asked */
  width:auto;
}
.date-section{display:flex}
.date-range-filter{
  background:rgba(255,255,255,.15);backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:12px 18px;
  box-shadow:0 4px 15px rgba(59,130,246,.15);transition:all .25s ease;
  animation:subtleGlow 6s ease-in-out infinite;max-width:280px;
}
@keyframes subtleGlow{
  0%{box-shadow:0 4px 15px rgba(59,130,246,.15)}
  50%{box-shadow:0 6px 20px rgba(59,130,246,.25)}
  100%{box-shadow:0 4px 15px rgba(59,130,246,.15)}
}
.date-range-filter:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,.25)}
.date-range-inputs{display:flex;gap:10px;margin-bottom:10px}
.date-range-input{flex:1;display:flex;flex-direction:column;gap:5px}
.date-range-input label{font-size:11px;color:#1e40af;font-weight:600;text-align:center}
.date-range-input input{
  width:100%;border:0;background:transparent;color:#1e40af;font-weight:700;font-size:13px;text-align:center;cursor:pointer;
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;padding:6px;border-bottom:1px solid #dbeafe
}
.date-range-input input:focus{outline:none;border-bottom-color:#3b82f6}
.date-range-input input::-webkit-calendar-picker-indicator{cursor:pointer;color:#1e40af;opacity:.7}
.date-range-actions{display:flex;gap:10px;justify-content:center}
.date-range-btn{
  padding:6px 12px;border:0;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s ease;flex:1;max-width:120px
}
.date-range-btn.apply{background:#3b82f6;color:#fff}
.date-range-btn.clear{background:#e2e8f0;color:#1e40af;border:1px solid #3b82f6}
.date-range-btn:hover{opacity:.9;transform:translateY(-1px)}

/* ======== CONTROLS ROW (Search (stacked) + Add button centered) ======== */
.controls-section{
  /* grid lets us stack the two search bars and keep the +New order button centered */
  display:grid;
  grid-template-columns: auto auto;    /* col 1: stacked searches, col 2: button */
  column-gap:24px;
  align-items:start;
  margin-top:76px;  /* space below the floating date filter so nothing collides */
  width:100%;
}

/* both search bars live in column 1 and naturally stack as two rows */
.controls-section .search-bar{
  grid-column:1;
  width:360px;      /* nice width on desktop; adjust if you want */
  max-width:100%;
}
.search-bar input{
  width:100%;padding:10px 12px;border:2px solid #3b82f6;border-radius:8px;background:#fff;font-size:14px;outline:none;box-sizing:border-box
}
.search-bar + .search-bar{ margin-top:15px; } /* little gap between stacked inputs */
 
.search-bar input:focus{border-color:#2563eb;box-shadow:0 0 5px rgba(59,130,246,.3)}
.search-bar input:hover{border-color:#2563eb}

/* center the button in column 2 */
.add-btn-container{
  grid-column:2;
  justify-self:center;  /* CENTERED as requested */
  align-self:start;
}
.add-btn{
  background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:#fff;border:0;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;
  transition:all .3s ease;box-shadow:0 4px 15px rgba(37,99,235,.3);text-decoration:none;display:inline-flex;align-items:center;justify-content:center;
  white-space:nowrap;height:40px;padding:0 24px;min-width:220px;max-width:500px
}
.add-btn:hover{box-shadow:0 6px 20px rgba(37,99,235,.4)}

/* ================== TABLE ================== */
.data-table{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;margin-top:20px;border-radius:10px;background:#fff}
table{width:100%;border-collapse:collapse;min-width:600px}
th,td{padding:14px 16px;text-align:left;border-bottom:1px solid #e2e8f0;transition:all .2s ease}
th{
  background:linear-gradient(135deg,#2563eb 0%,#1e40af 100%);color:#fff;font-weight:600;border-top:none;position:sticky;top:0;
  text-shadow:0 1px 2px rgba(0,0,0,.2);z-index:1
}
tr:hover{background:rgba(37,99,235,.05);transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.05)}
.customer-name{font-weight:700;color:#333}
.customer-phone{color:#666;font-size:.9em}
.quantity{font-weight:700;color:#28a745}
.amount{font-weight:700;color:#007bff}
.order-date{color:#6c757d}
.view-order-btn{background:#0056b3;color:#fff;border:0;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:.9em;white-space:nowrap}
.view-order-btn:hover{background:#5294db}
.actions{display:flex;gap:8px}
.action-btn{
  background:none;border:0;cursor:pointer;font-size:1.1em;padding:5px;border-radius:4px;width:32px;height:32px;display:flex;align-items:center;justify-content:center
}

/* ================== MODAL ================== */
.modal{
  display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);animation:modalFadeIn .3s ease;overflow:auto
}
@keyframes modalFadeIn{from{opacity:0}to{opacity:1}}
.modal-content{
  background:linear-gradient(145deg,#fff 0%,#f8fafc 100%);margin:0;border-radius:0;box-shadow:none;border:0;width:100%;height:100vh;overflow:hidden;
  position:relative;display:flex;flex-direction:column
}
.modal-content::before{
  content:"";position:absolute;inset:0;background:linear-gradient(135deg,#3b82f6,#1e40af);border-radius:20px;padding:3px;
  mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);mask-composite:exclude;z-index:-1
}
.close-modal{
  position:absolute;top:15px;right:20px;font-size:28px;font-weight:700;color:#1e40af;cursor:pointer;transition:all .3s ease;z-index:10;
  width:35px;height:35px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(59,130,246,.1)
}
.close-modal:hover{color:#ef4444;background:rgba(239,68,68,.1);transform:rotate(90deg) scale(1.1)}
.modal-header{
  background:#618cb8;padding:8px 15px;border-radius:12px 12px 0 0;color:#fff;border-bottom:1px solid rgba(255,255,255,.2);position:relative;overflow:hidden
}
.modal-header::before{
  content:"";position:absolute;top:0;left:0;right:0;height:100%;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 60"><circle cx="20" cy="15" r="1.2" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="45" cy="35" r="0.8" fill="rgba(255,255,255,0.1)"/></svg>');
  opacity:.4;background-size:50px 20px
}
.modal-title{color:#fff;font-size:24px;font-weight:700;margin:5px 0 20px;position:relative;z-index:1;text-shadow:0 2px 4px rgba(0,0,0,.2)}
.order-info-grid{
  display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:15px;position:relative;z-index:1;max-height:120px;overflow-y:auto;overflow-x:hidden;padding-right:6px
}
.order-info-grid::-webkit-scrollbar{width:6px}
.order-info-grid::-webkit-scrollbar-thumb{background:rgba(0,0,0,.3);border-radius:3px}
.info-item{display:flex;align-items:center;background:rgba(255,255,255,.2);padding:8px 12px;border-radius:8px;backdrop-filter:blur(10px)}
.info-label{font-weight:600;color:rgba(255,255,255,.9);width:120px;flex-shrink:0;font-size:14px}
.info-value{color:#fff;flex-grow:1;font-weight:500}
.summary-stats{
  display:flex;justify-content:space-between;background:rgba(255,255,255,.15);padding:15px 20px;border-radius:12px;margin-top:20px;backdrop-filter:blur(10px);position:relative;z-index:1
}
.stat-item{text-align:center}
.stat-label{font-size:12px;color:rgba(255,255,255,.8);margin-bottom:5px;font-weight:500}
.stat-value{font-size:18px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.2)}
.modal-body{
  padding:15px 20px;flex:1;overflow:auto;background:linear-gradient(135deg,#f8fafc 0%,#fff 100%);min-height:40vh;max-height:45vh
}
.modal-header,.modal-footer{width:100%;border-radius:0}
.modal-table-container{overflow:auto;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.1);background:#fff}
.order-items-table{width:100%;border-collapse:collapse;min-width:650px}
.order-items-table th{
  background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);padding:15px 12px;text-align:left;font-weight:600;border-bottom:2px solid #1854a2;color:#1e40af;
  font-size:14px;position:sticky;top:0;z-index:2
}
.order-items-table td{padding:15px 12px;border-bottom:1px solid #f1f5f9;color:#374151;font-size:14px}
.order-items-table tr:hover{background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%)}
.order-items-table th:nth-child(3),.order-items-table td:nth-child(3){text-align:right}
.order-items-table th:nth-child(4),.order-items-table td:nth-child(4){text-align:center}
.order-items-table th:nth-child(5),.order-items-table td:nth-child(5){text-align:right}
.order-items-table th:nth-child(6),.order-items-table td:nth-child(6){text-align:center}
.quantity-control{display:flex;align-items:center;justify-content:center;gap:8px;min-width:120px}
.quantity-btn{
  width:28px;height:28px;border:2px solid #3b82f6;background:linear-gradient(135deg,#fff 0%,#f8fafc 100%);cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-weight:700;border-radius:6px;font-size:14px;transition:all .2s ease
}
.quantity-btn:hover{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;transform:scale(1.05)}
.quantity-btn:disabled{background:#f1f5f9;color:#9ca3af;cursor:not-allowed;border-color:#e5e7eb;transform:none}
.quantity-value{font-weight:600;color:#1e40af;min-width:25px;text-align:center}
.modal-footer{padding:25px 30px;border-top:1px solid #e5e7eb;background:linear-gradient(135deg,#f8fafc 0%,#fff 100%);border-radius:0 0 20px 20px}
.total-section{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px 20px;background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%);
  border-radius:12px;color:#fff
}
.total-amount{font-size:24px;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,.2)}
.footer-buttons{display:flex;gap:15px;justify-content:flex-end}
.btn{padding:12px 24px;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .3s ease;position:relative;overflow:hidden}
.btn::before{content:"";position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.2);border-radius:50%;transform:translate(-50%,-50%);transition:width .6s,height .6s}
.btn:hover::before{width:300px;height:300px}
.btn-primary{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;box-shadow:0 4px 15px rgba(59,130,246,.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(59,130,246,.4)}
.btn-secondary{background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);color:#fff;box-shadow:0 4px 15px rgba(107,114,128,.3)}
.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(107,114,128,.4)}

/* ================== TOAST ================== */
.success-message{
  position:fixed;bottom:20px;right:20px;background:#16a34a;color:#fff;padding:10px 14px;border-radius:8px;
  box-shadow:0 6px 20px rgba(0,0,0,.2);font-size:14px;z-index:9999
}

/* ================== DESKTOP HEADER TWEAKS ================== */
@media (min-width:768px){
  .header-content{flex-direction:row;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .welcome-text{position:absolute;left:50%;transform:translateX(-50%);text-align:center;margin-bottom:0;width:auto}
  .user-info{text-align:left;order:0;width:auto}
  .header-actions{justify-content:flex-end;order:2;width:auto}
}

/* ================== MOBILE ================== */
@media (max-width:767px){
  .content-header{
    position:static; /* date filter returns to normal flow on mobile */
    margin-top:10px;
  }
  .date-range-filter{max-width:100%}

  .controls-section{
    display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:10px;width:100%;
  }
  .controls-section .search-bar{width:100%}
  .search-bar input{
    width:100%;padding:12px 14px;border-radius:8px;border:2px solid #3b82f6;background:#f0f7ff;font-size:14px;transition:all .3s ease;outline:none;box-sizing:border-box
  }
  .search-bar input:focus{border-color:#2563eb;box-shadow:0 0 8px rgba(37,99,235,.4);background:#fff}
  .add-btn-container{width:100%;justify-content:center;display:flex}
  .add-btn{width:100%;max-width:500px;padding:10px 15px;font-size:14px;white-space:nowrap}
}

     
/* === Desktop positioning tweak: search bars left, button center, date filter lower === */
/* === Desktop positioning tweak: wider button, lift everything up === */
@media (min-width: 768px) {

  /* raise the whole controls section closer to the header */
  .controls-section {
    margin-top: 2px !important;  /* smaller = higher */
     margin-left: 10px;
  }

  /* search bars: keep stacked on left */
  .controls-section .search-bar {
    width: 460px;      /* adjust if you want wider inputs */
    max-width: 100%;
  }

 
/* center button: make wider and lift closer to searches */
.add-btn-container {
  grid-column: 1 / span 2;     /* ✅ spans the full row of the grid */
  display: flex;
  justify-content: center;     /* ✅ always centers horizontally */
  margin-top: 2px !important;  /* controls vertical gap below search bars */
  width: 100%;                 /* ensures it has full width to center inside */
}

.add-btn {
  min-width: 300px !important;  /* wider button */
  max-width: 400px !important;
  height: 45px;
  font-size: 16px;
}

  /* lower the date filter slightly so spacing looks balanced */
  .content-header {
    top: 45px !important;   /* increase to move it further down */
    right: 24px;
  }
}

/* === Status Colors === */
.status-select {
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  border: none;
  color: #fff;
}

.status-select.pending {
  background-color: #facc15; /* Yellow */
  color: #000;              /* Dark text for contrast */
}

.status-select.completed {
  background-color: #22c55e; /* Green */
}

.status-select.sold-out {
  background-color: #ef4444; /* Red */
}
/*  */


    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="user-info">
                    <p id="userInfoText">Loading...</p>
                </div>
                <div class="welcome-text">
                    <h2>Dashboard Overview</h2>
                </div>
                <div class="header-actions">
                    <button class="logout-button" id="logout-btn">Logout</button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- <h2 class="dashboard-title">Dashboard Overview</h2> -->

            
           <div class="content-header">
    <div class="date-section">
        <div class="date-range-filter">
            <!-- <div class="date-range-filter-label">Filter by Date Range</div> -->
            <div class="date-range-inputs">
                <div class="date-range-input">
                    <label for="fromDate">From</label>
                    <input type="date" id="fromDate" title="Start date">
                </div>
                <div class="date-range-input">
                    <label for="toDate">To</label>
                    <input type="date" id="toDate" title="End date">
                </div>
            </div>
            <div class="date-range-actions">
                <button class="date-range-btn apply" onclick="applyDateRangeFilter()">Apply</button>
                <button class="date-range-btn clear" onclick="clearDateRangeFilter()">Back To Dashboard</button>
            </div>
        </div>
    </div>
</div>

            </div>
            <div class="controls-section">
                <div class="search-bar ">
                    <input type="text" id="searchInput" placeholder=" Search by Customer Name or Phone Number">
                </div>
                <div class="search-bar">
                    <input type="text" id="searchByIdInput" placeholder="Search by Entry Number or Order ID">
                </div>

                <div class="add-btn-container">
                     <!-- <a href="{% url 'neworder' %}" class="add-btn">+ Add Customer</a>  -->
                    <a href="/orders/?mode=new" class="add-btn"> + New order</a>



                </div>
            </div>

            <div class="data-table">
                <table id="orderTable">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Order Date</th>
                            <th>Created By</th> 
                            <th>Customer</th>
                            <th>Phone Number</th>
                            <th>Total Quantity</th>
                            <th>Amount</th>
                            <th>Edit</th>
                             <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Order History Modal -->
    <div id="orderHistoryModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            
            <div class="modal-header">
                <h2 class="modal-title">Order Details</h2>
<div class="order-info-grid">
    <div class="info-item">
        <span class="info-label">Order ID:</span>
        <span class="info-value" id="modalOrderId">ORD-2024-001</span>
    </div>
    <div class="info-item">
        <span class="info-label">Order Date:</span>
        <span class="info-value" id="modalOrderDate">2024-07-12</span>
    </div>
    <div class="info-item">
        <span class="info-label">Created By:</span>
        <span class="info-value" id="modalCreatedBy">Admin User</span>
    </div>
    <div class="info-item">
        <span class="info-label">Customer:</span>
        <span class="info-value" id="modalCustomerName">John Doe</span>
    </div>
    <div class="info-item">
        <span class="info-label">Created On:</span>
        <span class="info-value" id="modalCreatedOn">2024-07-12 10:30 AM</span>
    </div>
    <div class="info-item">
        <span class="info-label">Place:</span>
        <span class="info-value" id="modalPlace">Downtown Store</span>
    </div>
</div>


                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-label">Item Types</div>
                        <div class="stat-value" id="modalItemTotal">4</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Items</div>
                        <div class="stat-value" id="modalItemCount">14</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Bill Total</div>
                        <div class="stat-value rupee" id="modalBillTotal">59.00</div>
                    </div>
                </div>
            </div>

            <div class="modal-body">
                <div class="modal-table-container">
                    <table class="order-items-table">
                        <thead>
                            <tr>
                                <th class="text-center">SL No</th>
                                <th>Item Name</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="modalOrderItemsList">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <div class="total-section">
                    <span style="font-size: 20px; font-weight: 600;">Grand Total:</span>
                    <span class="total-amount rupee" id="modalGrandTotal">59.00</span>
                </div>
                <div class="footer-buttons">
                    <button class="btn btn-primary" id="updateOrderBtn">Update Order</button>
                    <button class="btn btn-success" id="addProductsFromModal">Add Products</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
/* ========= declare cross-function state ========= */
let currentOrderDetails = null;

/* ========= utility ========= */
function formatPrice(price) {
    const num = typeof price === 'string' ? parseFloat(price) : price;
    return num.toFixed(2);
}

/* ========= live order list per customer ========= */
function getCustomerOrders() {
    return JSON.parse(localStorage.getItem('orders_all') || '[]');
}
let orderData = getCustomerOrders();

/* ========= logout ========= */
const logoutButton = document.getElementById("logout-btn");
logoutButton.addEventListener("click", () => {
    if (confirm("Are you sure you want to logout?")) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("user_id");
        localStorage.removeItem("client_id");
        window.location.href = "/login";
    }
});

const userInfoText = document.getElementById('userInfoText');
const userId = localStorage.getItem('user_id');
const clientId = localStorage.getItem('client_id');
if (userId && clientId) {
    userInfoText.textContent = `ID: ${clientId} | USERID: ${userId}`;
} else {
    userInfoText.textContent = "User not logged in";
}

/* ========= date helpers ========= */
function updateCurrentDate() {
    const now = new Date();
    const todayISO = now.toISOString().split('T')[0];
    document.getElementById('fromDate').value = todayISO;
    document.getElementById('toDate').value = todayISO;
}

/* ========= populate table ========= */
function populateTable() {
    const tableBody = document.getElementById('orderTableBody');
    tableBody.innerHTML = '';

    orderData.forEach((order, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-id', order.id);
        const dateParts = order.orderDate.split('/');
        row.setAttribute('data-date', `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);

        // Ensure every order has a status; default to "Pending"
        if (!order.status) order.status = 'Pending';

        // Get the logged-in user's ID
        const userId = localStorage.getItem('user_id') || "Unknown";

        row.innerHTML = `
            <td>${order.serialNo}</td>
            <td><span class="order-date">${order.orderDate}</span></td>
            <td>${userId}</td> <!-- New column data -->
            <td><div class="customer-name">${order.customer}</div></td>
            <td class="customer-phone">${order.phone}</td>
            <td><div class="quantity-wrapper"><span class="quantity">${order.quantity}</span></div></td>
            <td><span class="amount rupee">${formatPrice(order.amount)}</span></td>
            <td>
                <button class="view-order-btn" onclick="viewOrder(${index})">Show Items</button>
            </td>
            <!-- STATUS COLUMN WITH MANUAL SELECTOR -->
            <td>
                <select class="status-select ${order.status.toLowerCase().replace(' ', '-')}" 
                    onchange="changeOrderStatus(${index}, this.value)">
                    <option value="Pending"   ${order.status === 'Pending'   ? 'selected' : ''}>Pending</option>
                    <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                    <option value="Sold Out"  ${order.status === 'Sold Out'  ? 'selected' : ''}>Sold Out</option>
                </select>
            </td>

            <td>
                <div class="actions">
                    <button class="action-btn delete-btn" onclick="deleteEntry(${order.id})">🗑️</button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}
/* ========= search ========= */
function setupSearch() {
    document.getElementById('searchInput').addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('#orderTableBody tr');

        rows.forEach(row => {
            const customerName = row.querySelector('.customer-name').textContent.toLowerCase();
            const phoneNumber = row.querySelector('.customer-phone').textContent.toLowerCase();
            const rowText = customerName + ' ' + phoneNumber;

            row.style.display = rowText.includes(filter) ? '' : 'none';
        });
    });
}

/* ========= date filter ========= */
function applyDateRangeFilter() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;

    if (fromDate && toDate) {
        const fromDateObj = new Date(fromDate);
        const toDateObj = new Date(toDate);

        if (fromDateObj > toDateObj) {
            alert('From Date cannot be after To Date');
            return;
        }

        filterTableByDateRange(fromDate, toDate);
    } else {
        const rows = document.querySelectorAll('#orderTableBody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
    }
}

function clearDateRangeFilter() {
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    updateCurrentDate();
    
    // Apply today's filter when going back to dashboard
    const todayISO = new Date().toISOString().split('T')[0];
    filterTableByDateRange(todayISO, todayISO);
}
function filterTableByDateRange(fromDate, toDate) {
    const fromDateObj = new Date(fromDate);
    const toDateObj = new Date(toDate);

    const rows = document.querySelectorAll('#orderTableBody tr');
    rows.forEach(row => {
        const rowDate = row.getAttribute('data-date');
        const rowDateObj = new Date(rowDate);

        if (rowDateObj >= fromDateObj && rowDateObj <= toDateObj) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

/* ========= delete order ========= */
function deleteEntry(id) {
    if (confirm(`Are you sure you want to delete order #${id}?`)) {
        let orders = JSON.parse(localStorage.getItem('orders_all') || '[]');
        orders = orders.filter(o => o.id !== id);
        localStorage.setItem('orders_all', JSON.stringify(orders));
        orderData = orders;
        populateTable();
    }
}

/* ========= view order modal ========= */
function viewOrder(orderIndex) {
    const order = orderData[orderIndex];
    if (!order) return;

    currentOrderDetails = {
        orderId: order.serialNo,
        orderDate: order.orderDate,
        customerName: order.customer,
        place: order.place || 'Unknown', // Provide a default value if place is missing
        createdBy: 'System',
        createdOn: `${order.orderDate} ${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}`,
        items: order.items
    };

    /* header */
    document.getElementById('modalOrderId').textContent   = currentOrderDetails.orderId;
    document.getElementById('modalOrderDate').textContent = currentOrderDetails.orderDate;
    document.getElementById('modalCustomerName').textContent = currentOrderDetails.customerName;
    document.getElementById('modalPlace').textContent  = currentOrderDetails.place; // This will now show 'Unknown' if place is missing
    document.getElementById('modalCreatedBy').textContent = currentOrderDetails.createdBy;
    const createdDate = new Date(currentOrderDetails.createdOn).toLocaleDateString();
    document.getElementById('modalCreatedOn').textContent = createdDate;


    /* totals */
    updateOrderTotals();

    /* items */
    const itemsList = document.getElementById('modalOrderItemsList');
    itemsList.innerHTML = '';
    currentOrderDetails.items.forEach((item, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-item-id', item.id);
        row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td>${item.name}</td>
            <td class="text-right rupee">${formatPrice(item.price)}</td>
            <td class="text-center">
                <div class="quantity-control">
                    <button class="quantity-btn" onclick="decreaseQuantity(${index})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn" onclick="increaseQuantity(${index})">+</button>
                </div>
            </td>
            <td class="text-right rupee">${formatPrice(item.total)}</td>
            <td class="text-right">
                <button class="action-btn delete-btn" onclick="deleteOrderItem(${index})" title="Delete Item">🗑️</button>
            </td>
        `;
        itemsList.appendChild(row);
    });

    document.getElementById('orderHistoryModal').style.display = 'block';
}

/* ========= modal totals & actions ========= */
function updateOrderTotals() {
    if (!currentOrderDetails) return;
    const itemTotal = currentOrderDetails.items.length;
    const itemCount = currentOrderDetails.items.reduce((sum, item) => sum + item.quantity, 0);
    const billTotal = currentOrderDetails.items.reduce((sum, item) => sum + item.total, 0);

    document.getElementById('modalItemTotal').textContent = itemTotal;
    document.getElementById('modalItemCount').textContent = itemCount;
    document.getElementById('modalBillTotal').textContent = formatPrice(billTotal);
    document.getElementById('modalGrandTotal').textContent = formatPrice(billTotal);
}

function deleteOrderItem(itemIndex) {
    if (!currentOrderDetails || !confirm('Are you sure you want to delete this item?')) return;
    
    // Get the item being deleted
    const deletedItem = currentOrderDetails.items[itemIndex];
    
    // Remove from current order details
    currentOrderDetails.items.splice(itemIndex, 1);
    
    // Find and update the main order data
    const orderIndex = orderData.findIndex(o => o.serialNo === currentOrderDetails.orderId);
    if (orderIndex !== -1) {
        // Update the main order with new items array
        orderData[orderIndex].items = [...currentOrderDetails.items];
        
        // Recalculate totals
        const newQuantity = currentOrderDetails.items.reduce((sum, item) => sum + item.quantity, 0);
        const newAmount = currentOrderDetails.items.reduce((sum, item) => sum + item.total, 0);
        
        orderData[orderIndex].quantity = newQuantity;
        orderData[orderIndex].amount = newAmount;
        
        // Save to localStorage
        localStorage.setItem('orders_all', JSON.stringify(orderData));
    }
    
    // Update the cart data to remove this item
    const customerName = document.getElementById('modalCustomerName').textContent;
    const cartData = JSON.parse(localStorage.getItem('cartData') || '{}');
    
    if (cartData[customerName] && deletedItem) {
        // Remove the deleted item from cart
        delete cartData[customerName][deletedItem.id];
        localStorage.setItem('cartData', JSON.stringify(cartData));
    }
    
    // Update modal display
    updateOrderTotals();
    
    // Refresh the modal view
    viewOrder(orderIndex);
    
    // Refresh the main table
    populateTable();
    
    // Show success message
    showSuccessMessage(`${deletedItem.name} has been removed from the order`);
}

// Also update the increaseQuantity and decreaseQuantity functions to sync properly
function increaseQuantity(itemIndex) {
    if (!currentOrderDetails) return;
    const item = currentOrderDetails.items[itemIndex];
    item.quantity += 1;
    item.total = item.price * item.quantity;
    
    // Sync with main order data
    const orderIndex = orderData.findIndex(o => o.serialNo === currentOrderDetails.orderId);
    if (orderIndex !== -1) {
        orderData[orderIndex].items = [...currentOrderDetails.items];
        
        // Recalculate totals
        const newQuantity = currentOrderDetails.items.reduce((sum, item) => sum + item.quantity, 0);
        const newAmount = currentOrderDetails.items.reduce((sum, item) => sum + item.total, 0);
        
        orderData[orderIndex].quantity = newQuantity;
        orderData[orderIndex].amount = newAmount;
        
        localStorage.setItem('orders_all', JSON.stringify(orderData));
    }
    
    // Update cart data
    const customerName = document.getElementById('modalCustomerName').textContent;
    const cartData = JSON.parse(localStorage.getItem('cartData') || '{}');
    if (cartData[customerName]) {
        cartData[customerName][item.id] = item.quantity;
        localStorage.setItem('cartData', JSON.stringify(cartData));
    }
    
    updateOrderTotals();
    viewOrder(orderIndex);
    populateTable();
}

function decreaseQuantity(itemIndex) {
    if (!currentOrderDetails) return;
    const item = currentOrderDetails.items[itemIndex];
    if (item.quantity > 1) {
        item.quantity -= 1;
        item.total = item.price * item.quantity;
        
        // Sync with main order data
        const orderIndex = orderData.findIndex(o => o.serialNo === currentOrderDetails.orderId);
        if (orderIndex !== -1) {
            orderData[orderIndex].items = [...currentOrderDetails.items];
            
            // Recalculate totals
            const newQuantity = currentOrderDetails.items.reduce((sum, item) => sum + item.quantity, 0);
            const newAmount = currentOrderDetails.items.reduce((sum, item) => sum + item.total, 0);
            
            orderData[orderIndex].quantity = newQuantity;
            orderData[orderIndex].amount = newAmount;
            
            localStorage.setItem('orders_all', JSON.stringify(orderData));
        }
        
        // Update cart data
        const customerName = document.getElementById('modalCustomerName').textContent;
        const cartData = JSON.parse(localStorage.getItem('cartData') || '{}');
        if (cartData[customerName]) {
            cartData[customerName][item.id] = item.quantity;
            localStorage.setItem('cartData', JSON.stringify(cartData));
        }
        
        updateOrderTotals();
        viewOrder(orderIndex);
        populateTable();
    }
}

// SAVE MODAL CHANGES (single definition kept)
function saveUpdatedOrder() {
    const orderIndex = orderData.findIndex(o => o.serialNo === currentOrderDetails.orderId);
    if (orderIndex === -1) return;

    const newQuantity = currentOrderDetails.items.reduce((sum, i) => sum + i.quantity, 0);
    const newAmount = currentOrderDetails.items.reduce((sum, i) => sum + i.total, 0);

    /* Update the existing order */
    orderData[orderIndex] = {
        ...orderData[orderIndex],
        items: [...currentOrderDetails.items],
        quantity: newQuantity,
        amount: newAmount,
        orderDate: new Date().toLocaleDateString('en-GB')
    };

    localStorage.setItem('orders_all', JSON.stringify(orderData));
    
    /* Update cart to reflect current order state */
    const customerName = document.getElementById('modalCustomerName').textContent;
    const cartData = JSON.parse(localStorage.getItem('cartData') || '{}');
    cartData[customerName] = currentOrderDetails.items.reduce((acc, item) => {
        acc[item.id] = item.quantity;
        return acc;
    }, {});
    localStorage.setItem('cartData', JSON.stringify(cartData));

    /* Redraw table and close modal */
    populateTable();
    closeModal();
    showSuccessMessage("Order updated successfully!");
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    setTimeout(() => successDiv.remove(), 3000);
}

function closeModal() {
    document.getElementById('orderHistoryModal').style.display = 'none';
}

/* ========= status change handler ========= */
function changeOrderStatus(orderIndex, newStatus) {
    orderData[orderIndex].status = newStatus;
    localStorage.setItem('orders_all', JSON.stringify(orderData));
    populateTable();
    
    // Re-apply current date filter after status change
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    if (fromDate && toDate) {
        // If date filter is active, maintain it
        filterTableByDateRange(fromDate, toDate);
    } else {
        // If no date filter, apply today's filter
        const todayISO = new Date().toISOString().split('T')[0];
        filterTableByDateRange(todayISO, todayISO);
    }
}

/* ========= init ========= */
document.addEventListener('DOMContentLoaded', function () {
    updateCurrentDate();
    orderData = getCustomerOrders();
    populateTable();
    setupSearch();

    // ✅ Always filter to show only today's orders by default
    const todayISO = new Date().toISOString().split('T')[0];
    filterTableByDateRange(todayISO, todayISO);

    setInterval(updateCurrentDate, 60000);

    /* refresh on tab focus */
    window.addEventListener('focus', () => {
        orderData = getCustomerOrders();
        populateTable();
        // ✅ Re-apply today's filter after refresh
        const todayISO = new Date().toISOString().split('T')[0];
        filterTableByDateRange(todayISO, todayISO);
    });
    /* modal close handlers */
    const modal = document.getElementById('orderHistoryModal');
    const closeBtn = document.querySelector('.close-modal');
    if (closeBtn) closeBtn.onclick = closeModal;
    window.onclick = e => { if (e.target === modal) closeModal(); };
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    document.getElementById('updateOrderBtn').addEventListener('click', () => {
        saveUpdatedOrder();
    });
});

function redirectToAddProducts() {
    window.location.href = "order.html";
}

document.getElementById('addProductsFromModal').addEventListener('click', function () {
    // Get current order details
    const customerName = document.getElementById('modalCustomerName').textContent;
    const customerPlace = document.getElementById('modalPlace').textContent;
    const customerPhone = document.getElementById('modalCustomerPhone')?.textContent || '';

    // Store customer info for order.html
    localStorage.setItem('selected_customer', JSON.stringify({
        name: customerName,
        place: customerPlace,
        phone: customerPhone
    }));

    // Get existing cart data
    const cartData = JSON.parse(localStorage.getItem('cartData') || '{}');
    const custKey = customerName;
    if (!cartData[custKey]) cartData[custKey] = {};

    // Only add current modal items to cart (this represents the current state)
    // The cart will show current quantities, and when placing order,
    // only NEW additions beyond the original order will be processed
    currentOrderDetails.items.forEach(item => {
        cartData[custKey][item.id] = item.quantity;
    });

    localStorage.setItem('cartData', JSON.stringify(cartData));

    // Close modal and redirect (template tag kept as-is, backend untouched)
    closeModal();
    window.location.href = "{% url 'orders' %}";
});

// Search by ID

document.getElementById('searchByIdInput').addEventListener('input', function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#orderTableBody tr');
    rows.forEach(row => {
        const orderId = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
        row.style.display = orderId.includes(filter) ? '' : 'none';
    });
});
// ========= Add Products button =========
document.getElementById('addProductsFromModal').addEventListener('click', () => {
    localStorage.setItem('editing_order', JSON.stringify(currentOrderDetails));
    window.location.href = '/orders/?mode=edit';
});


</script>
</body>
</html>
