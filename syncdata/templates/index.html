<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Dashboard Overview</title>
    <style>
      /* ================== RESET & BASE ================== */
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f3ff 0%, #ddd6fe 100%);
        min-height: 100vh;
        padding: 20px;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      /* ================== HEADER ================== */
      .header {
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        color: #fff;
        padding: 20px;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        opacity: 0.3;
      }

      .header-content {
        position: relative;
        z-index: 1;
        display: flex;
        /* flex-direction: column; */
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        width: 100%;
      }

      .welcome-text {
        text-align: center;
      }

      @keyframes textGlow {
        from {
          text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }

        to {
          text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        }
      }

      .welcome-text h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        animation: textGlow 2s ease-in-out infinite alternate;
        background: linear-gradient(to right, #fff, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .user-info {
        text-align: center;
        animation: fadeIn 1s ease-out 0.5s both;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }

      .user-info p {
        margin: 0;
        font-size: 14px;
        color: #e0e7ff;
      }

      .header-actions {
        display: flex;
        justify-content: center;
        order: 3;
        /* width: 100% */
      }

      .logout-button {
        padding: 10px 20px;
        background: #e63946;
        color: #fff;
        border: 0;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%;
        max-width: 120px;
      }

      .logout-button:hover {
        background: #d62828;
      }

      .logout-button:active {
        background: #b71c1c;
      }

      /* ================== MAIN ================== */
      .main-content {
        padding: 20px;
        position: relative;
      }

      /* ======== DATE FILTER (in header band) ======== */
      .content-header {
        /* position: absolute; */
        /* let the date card float at the top-right of main content */
        /* right: 24px;
            top: -12px; */
        /* LIFTED a little more as you asked */
        width: auto;
      }

      .date-section {
        display: flex;
      }

      .date-range-filter {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 12px 18px;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
        transition: all 0.25s ease;
        animation: subtleGlow 6s ease-in-out infinite;
        max-width: 280px;
      }

      @keyframes subtleGlow {
        0% {
          box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
        }

        50% {
          box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
        }

        100% {
          box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
        }
      }

      .date-range-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.25);
      }

      .date-range-inputs {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .date-range-input {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .date-range-input label {
        font-size: 11px;
        color: #1e40af;
        font-weight: 600;
        text-align: center;
      }

      .date-range-input input {
        width: 100%;
        border: 0;
        background: transparent;
        color: #1e40af;
        font-weight: 700;
        font-size: 13px;
        text-align: center;
        cursor: pointer;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 6px;
        border-bottom: 1px solid #dbeafe;
      }

      .date-range-input input:focus {
        outline: none;
        border-bottom-color: #3b82f6;
      }

      .date-range-input input::-webkit-calendar-picker-indicator {
        cursor: pointer;
        color: #1e40af;
        opacity: 0.7;
      }

      .date-range-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .date-range-btn {
        padding: 6px 12px;
        border: 0;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
        max-width: 120px;
      }

      .date-range-btn.apply {
        background: #3b82f6;
        color: #fff;
      }

      .date-range-btn.clear {
        background: #e2e8f0;
        color: #1e40af;
        border: 1px solid #3b82f6;
      }

      .date-range-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      /* ======== CONTROLS ROW (Search (stacked) + Add button centered) ======== */
      .controls-section {
        /* grid lets us stack the two search bars and keep the +New order button centered */
        display: grid;
        grid-template-columns: auto auto;
        /* col 1: stacked searches, col 2: button */
        column-gap: 24px;
        align-items: start;
        margin-bottom: 24px;
        position: relative;
        width: 100%;
      }

      .search-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .search-box {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .search-box:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .search-box::placeholder {
        color: #94a3b8;
      }

      .add-order-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .top-header-demo {
        display: flex;
        width: 100%;
        justify-content: space-between;
        row-gap: 20px;
        align-items: center;
        flex-wrap: wrap;
      }

      .add-order-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
        border: 0;
        border-radius: 12px;
        padding: 16px 24px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-width: 140px;
      }

      .add-order-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      }

      .add-order-btn:active {
        transform: translateY(0);
      }

      /* ======== TABLE ======== */
      .table-container {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      .table-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .table-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
      }

      .table-stats {
        font-size: 14px;
        color: #64748b;
        font-weight: 500;
      }

      .order-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .order-table th {
        background: #f8fafc;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        font-size: 13px;
        letter-spacing: 0.5px;
      }

      .order-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
      }

      .order-table tr:hover {
        background: #f9fafb;
      }

      .order-table tr:last-child td {
        border-bottom: 0;
      }

      /* ======== STATUS BADGES ======== */
      .status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
        min-width: 80px;
        text-align: center;
      }

      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }

      .status-completed {
        background: #d1fae5;
        color: #065f46;
      }

      .status-cancelled {
        background: #fee2e2;
        color: #991b1b;
      }

      /* ======== ACTION BUTTONS ======== */
      .action-btn {
        padding: 6px 12px;
        border: 0;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-right: 4px;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .view-btn {
        background: #3b82f6;
        color: #fff;
      }

      .view-btn:hover {
        background: #2563eb;
      }

      .edit-btn {
        background: #f59e0b;
        color: #fff;
      }

      .edit-btn:hover {
        background: #d97706;
      }

      .delete-btn {
        background: #ef4444;
        color: #fff;
      }

      .delete-btn:hover {
        background: #dc2626;
      }

      /* ======== MODAL ======== */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: #fff;
        padding: 0;
        border-radius: 12px;
        width: 100%;
        height: 100%;
        /* max-height: 90vh; */
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
        color: #fff;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
      }

      .close-modal {
        background: 0;
        border: 0;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s ease;
      }

      .close-modal:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .modal-body {
        padding: 20px;
      }

      .modal-footer {
        background: #f8fafc;
        padding: 16px 20px;
        border-radius: 0 0 12px 12px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        border-top: 1px solid #e2e8f0;
      }

      /* ======== ORDER DETAILS ======== */
      .order-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }

      .detail-item {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 12px 18px;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15);
      }

      .detail-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .detail-value {
        font-size: 14px;
        color: #1e293b;
        font-weight: 500;
      }

      /* ======== ORDER ITEMS TABLE ======== */
      .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        background: #ffffff;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #095bc7;
      }

      .items-table th {
        background: #f1f5f9;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #014ac0;
        font-size: 13px;
      }

      .items-table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
      }

      .items-table tr:last-child td {
        border-bottom: 0;
      }

      /* ======== QUANTITY CONTROLS ======== */
      .quantity-control {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .quantity-btn {
        width: 24px;
        height: 24px;
        border: 1px solid #d1d5db;
        background: #fff;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .quantity-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
      }

      .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .quantity-value {
        min-width: 30px;
        text-align: center;
        font-weight: 600;
        color: #374151;
      }

      /* ======== TOTALS SECTION ======== */
      .totals-section {
        background: #f8fafc;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
      }

      .total-item {
        text-align: center;
      }

      .total-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .total-value {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
      }

      /* ======== SUCCESS MESSAGE ======== */
      .success-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        z-index: 1001;
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(100%);
        }

        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* ======== LOADING ======== */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #64748b;
        font-size: 14px;
      }

      .loading::after {
        content: "";
        width: 20px;
        height: 20px;
        border: 2px solid #e2e8f0;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      /* ======== RESPONSIVE ======== */
      @media (max-width: 1000px) {
        .table-container {
          overflow-x: auto;
        }
      }
      

      @media (max-width: 800px) {
        .customButton {
          padding: 10px 20px;
          font-size: 12px;
        }

        .search-controls {
          width: 100%;
          padding: 0 20px;
        }
        .search-controls input {
          width: 100%;
        }

        .responsive {
          flex-direction: column;
        }
      }

      @media (max-width: 768px) {
        .controls-section {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .add-order-section {
          order: -1;
        }

        .date-range-filter {
          max-width: 100%;
        }

        .order-details {
          grid-template-columns: 1fr;
        }

        .totals-section {
          grid-template-columns: repeat(2, 1fr);
        }

        .modal-content {
          width: 95%;
          margin: 5% auto;
        }
      }

      @media (max-width: 480px) {
        .header-content {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-content" style="display: flex;">
          <div class="user-info" style="flex: 1; ">
            <p style="text-align: start;" id="loginInfo"></p>
          </div>
          <div class="welcome-text" style="flex: 1;">
            <h2 style="text-align: center;">Dashboard Overview</h2>
          </div>
          <div class="header-actions" style="flex: 1; display: flex; justify-content: end;">
            <button class="logout-button" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="top-header-demo">
          <div style="width: 100%;">
            <div class="responsive" style="width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                <div class="search-controls" style="flex: 1;">
                  <input
                    type="text"
                    class="search-box"
                    id="searchByIdInput"
                    placeholder="Search by Order ID..."
                    style="min-width: 250px;"
                  />
                  <input
                    type="text"
                    class="search-box"
                    id="searchByNameInput"
                    placeholder="Search by Customer Name..."
                  />
                </div>

              <div style="flex: 1; display: flex; height: 20vh; align-items: end; justify-content: center;">
                <button class="customButton" style="background: blue ; border-radius: 10px; color: #eee; 
                padding: 15px 50px; border: none; outline: none; 
                cursor: pointer; font-weight: 600; letter-spacing: 0.5px;"  onclick="redirectToAddProducts()">
                  + New Order
                </button>
              </div>

              <div class="content-header" style="flex: 1; display: flex; justify-content: end;">
                <div>
                  <form style="background: white; border: 1px solid #eee; padding: 10px; 
                  border-radius: 10px;" id="dateRangeForm">
                    <div class="date-range-inputs">
                      <div class="date-range-input">
                        <label for="fromDate">From Date</label>
                        <input
                          type="date"
                          id="fromDate"
                          name="fromDate"
                          autocomplete="off"
                        />
                      </div>
                      <div class="date-range-input">
                        <label for="toDate">To Date</label>
                        <input
                          type="date"
                          id="toDate"
                          name="toDate"
                          autocomplete="off"
                        />
                      </div>
                    </div>
                    <div class="date-range-actions">
                      <button type="submit" class="date-range-btn apply">
                        Apply
                      </button>
                      <button
                        type="button"
                        class="date-range-btn clear"
                        id="clearDateBtn"
                      >
                        Clear
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container" style="margin-top: 20px; width: 100%;">
          <table class="order-table">
            <thead>
              <tr style="height: 10vh;">
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Order ID</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Order Date</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Created By</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Customer</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Phone Number</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Total Quantity</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Amount</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Edit</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Status</th>
                <th style="background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%); color: #eee;">Actions</th>
              </tr>
            </thead>
            <tbody id="orderTableBody">
              <tr>
                <td colspan="9" class="loading">Loading orders...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderHistoryModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Order Details</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Order Details -->
          <div class="order-details">
            <div class="detail-item">
              <div class="detail-label">Order ID</div>
              <div class="detail-value" id="modalOrderId">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Customer Name</div>
              <div class="detail-value" id="modalCustomerName">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value" id="modalCustomerPhone">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Address</div>
              <div class="detail-value" id="modalPlace">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Created By</div>
              <div class="detail-value" id="modalCreatedBy">-</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Created On</div>
              <div class="detail-value" id="modalCreatedOn">-</div>
            </div>
          </div>

          <!-- Order Items -->
          <h4 style="margin-bottom: 16px; color: #1e293b">Order Items</h4>
          <table class="items-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="modalOrderItemsList"></tbody>
          </table>

          <!-- Totals -->
          <div class="totals-section">
            <div class="total-item">
              <div class="total-label">Total Quantity</div>
              <div class="total-value" id="modalItemTotal">0</div>
            </div>
            <div class="total-item">
              <div class="total-label">Quantity</div>
              <div class="total-value" id="modalItemCount">0</div>
            </div>
            <div class="total-item">
              <div class="total-label">Bill Total</div>
              <div class="total-value" id="modalBillTotal">‚Çπ0</div>
            </div>
            <div class="total-item">
              <div class="total-label">Grand Total</div>
              <div class="total-value" id="modalGrandTotal">‚Çπ0</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-btn edit-btn" id="addProductsFromModal">
            Add Products
          </button>
          <!-- <button class="action-btn view-btn" id="updateOrderBtn">Update Order</button> -->
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let orderData = [];
      let currentOrderDetails = null;
      let currentFilters = {
        fromDate: "",
        toDate: "",
        status: "",
        page: 1,
      };

      // User data (you'll need to pass this from Django)
      const userData = {
        user_id: localStorage.getItem("user_id"),
        client_id: localStorage.getItem("client_id"),
      };

      // API Base URL
      const API_BASE = "";

      // Utility functions
      function formatPrice(price) {
        return "‚Çπ" + parseFloat(price).toFixed(2);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-GB");
      }

      function showSuccessMessage(message) {
        const successDiv = document.createElement("div");
        successDiv.className = "success-message";
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
      }

      function showErrorMessage(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "success-message";
        errorDiv.style.background = "#ef4444";
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
      }

      // API Functions
      async function fetchOrders(filters = {}) {
        try {
          const params = new URLSearchParams({
            user_id: userData.user_id,
            client_id: userData.client_id,
            page: filters.page || 1,
            per_page: 20,
          });

          if (filters.fromDate) params.append("from_date", filters.fromDate);
          if (filters.toDate) params.append("to_date", filters.toDate);
          if (filters.status) params.append("status", filters.status);

          const response = await fetch(`${API_BASE}/api/orders/get/?${params}`);
          const data = await response.json();

          
          if (data.success) {
            return data;
          } else {
            throw new Error(data.error || "Failed to fetch orders");
          }
        } catch (error) {
          console.error("Error fetching orders:", error);
          showErrorMessage("Failed to load orders");
          return { orders: [], pagination: {} };
        }
      }

      async function updateOrderStatus(orderId, newStatus) {
        try {
          const response = await fetch(
            `${API_BASE}/api/orders/update-status/`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                order_id: orderId,
                status: newStatus,
              }),
            }
          );

          const data = await response.json();
          if (data.success) {
            showSuccessMessage("Order status updated successfully");
            loadOrders();
          } else {
            throw new Error(data.error || "Failed to update order status");
          }
        } catch (error) {
          console.error("Error updating order status:", error);
          showErrorMessage("Failed to update order status");
        }
      }

      async function deleteOrder(orderId) {
        if (!confirm("Are you sure you want to delete this order?")) return;

        try {
          const response = await fetch(`${API_BASE}/api/orders/delete/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              order_id: orderId,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showSuccessMessage("Order deleted successfully");
            loadOrders();
          } else {
            throw new Error(data.error || "Failed to delete order");
          }
        } catch (error) {
          console.error("Error deleting order:", error);
          showErrorMessage("Failed to delete order");
        }
      }

      async function updateOrderItem(itemId, quantity) {
        try {
          const response = await fetch(`${API_BASE}/api/orders/update-item/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              item_id: itemId,
              quantity: quantity,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showSuccessMessage("Order item updated successfully");
            viewOrder(currentOrderDetails.id);
          } else {
            throw new Error(data.error || "Failed to update order item");
          }
        } catch (error) {
          console.error("Error updating order item:", error);
          showErrorMessage("Failed to update order item");
        }
      }

      async function deleteOrderItem(itemId) {
        if (!confirm("Are you sure you want to delete this item?")) return;

        try {
          const response = await fetch(`${API_BASE}/api/orders/delete-item/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              item_id: itemId,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showSuccessMessage("Order item deleted successfully");
            viewOrder(currentOrderDetails.id);
            loadOrders();
          } else {
            throw new Error(data.error || "Failed to delete order item");
          }
        } catch (error) {
          console.error("Error deleting order item:", error);
          showErrorMessage("Failed to delete order item");
        }
      }

      // UI Functions
      function populateTable(orders = []) {
        const tbody = document.getElementById("orderTableBody");
        // const stats = document.getElementById("tableStats");

        if (orders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">No orders found</td></tr>';
          // stats.textContent = "No orders";
          return;
        }

        tbody.innerHTML = "";
        orders.forEach((order, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${order.order_number}</td>
                    <td>${formatDate(order.created_at)}</td>
                    <td>${localStorage.getItem("user_id") || "Guest"}</td>
                    <td>${order.customer_name}</td>
                    <td>${order.customer_phone || "-"}</td>
                    <td>${order.total_quantity}</td>
                    <td>${formatPrice(order.total_amount)}</td>
                    <td>
                      <button class="action-btn view-btn" 
                        onclick="viewOrder(${order.id})" 
                        title="View Details"
                      >Show Items</button>
                    </td>
                    <td>
                        <select onchange="updateOrderStatus(${
                          order.id
                        }, this.value)" class="status-badge status-${
            order.status
          }">
                            <option value="pending" ${
                              order.status === "pending" ? "selected" : ""
                            }>Pending</option>
                            <option value="completed" ${
                              order.status === "completed" ? "selected" : ""
                            }>Completed</option>
                            <option value="cancelled" ${
                              order.status === "cancelled" ? "selected" : ""
                            }>Cancelled</option>
                        </select>
                    </td>
                    
                    

                    <td>
                        
                        <button class="action-btn delete-btn" onclick="deleteOrder(${
                          order.id
                        })" title="Delete Order">üóëÔ∏è</button>
                    </td>
                `;
          tbody.appendChild(row);
        });

        stats.textContent = `${orders.length} orders`;
      }

      async function viewOrder(orderId) {
        try {
          const response = await fetch(
            `${API_BASE}/api/orders/get/?user_id=${userData.user_id}&client_id=${userData.client_id}&order_id=${orderId}`
          );
          const data = await response.json();

          if (data.success && data.orders.length > 0) {
            const order = data.orders.find((item) => item.id === orderId);
            currentOrderDetails = order;

            // Update modal header
            document.getElementById("modalOrderId").textContent =
              order.order_number;
            document.getElementById("modalCustomerName").textContent =
              order.customer_name;
            document.getElementById("modalCustomerPhone").textContent =
              order.customer_phone || "-";
            document.getElementById("modalPlace").textContent =
              order.customer_address || "-";
            document.getElementById("modalCreatedBy").textContent =
              userData.user_id;
            document.getElementById("modalCreatedOn").textContent = formatDate(
              order.created_at
            );

            // Update items table
            const itemsList = document.getElementById("modalOrderItemsList");
            itemsList.innerHTML = "";
            order.items.forEach((item, index) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.product_name}</td>
                            <td>${formatPrice(item.unit_price)}</td>
                            <td>
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="decreaseQuantity(${
                                      item.id
                                    })" ${
                item.quantity <= 1 ? "disabled" : ""
              }>-</button>
                                    <span class="quantity-value">${
                                      item.quantity
                                    }</span>
                                    <button class="quantity-btn" onclick="increaseQuantity(${
                                      item.id
                                    })">+</button>
                                </div>
                            </td>
                            <td>${formatPrice(item.total_price)}</td>
                            <td>
                                <button class="action-btn delete-btn" onclick="deleteOrderItem(${
                                  item.id
                                })" title="Delete Item">üóëÔ∏è</button>
                            </td>
                        `;
              itemsList.appendChild(row);
            });

            // Update totals
            document.getElementById("modalItemTotal").textContent =
              order.item_count;
            document.getElementById("modalItemCount").textContent =
              order.total_quantity;
            document.getElementById("modalBillTotal").textContent = formatPrice(
              order.total_amount
            );
            document.getElementById("modalGrandTotal").textContent =
              formatPrice(order.total_amount);

            // Show modal
            document.getElementById("orderHistoryModal").style.display =
              "block";
          } else {
            throw new Error("Order not found");
          }
        } catch (error) {
          console.error("Error viewing order:", error);
          showErrorMessage("Failed to load order details");
        }
      }

      function increaseQuantity(itemId) {
        const quantityElement =
          event.target.parentElement.querySelector(".quantity-value");
        const currentQuantity = parseInt(quantityElement.textContent);
        updateOrderItem(itemId, currentQuantity + 1);
      }

      function decreaseQuantity(itemId) {
        const quantityElement =
          event.target.parentElement.querySelector(".quantity-value");
        const currentQuantity = parseInt(quantityElement.textContent);
        if (currentQuantity > 1) {
          updateOrderItem(itemId, currentQuantity - 1);
        }
      }

      function closeModal() {
        document.getElementById("orderHistoryModal").style.display = "none";
        currentOrderDetails = null;
      }

      // Filter Functions
      function applyDateFilter() {
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;

        currentFilters.fromDate = fromDate;
        currentFilters.toDate = toDate;
        currentFilters.page = 1;

        loadOrders();
      }

      function clearDateFilter() {
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";

        currentFilters.fromDate = "";
        currentFilters.toDate = "";
        currentFilters.page = 1;

        loadOrders();
      }

      // Search Functions
      function setupSearch() {
        document
          .getElementById("searchByIdInput")
          .addEventListener("input", function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll("#orderTableBody tr");
            rows.forEach((row) => {
              const orderId =
                row
                  .querySelector("td:first-child")
                  ?.textContent.toLowerCase() || "";
              row.style.display = orderId.includes(filter) ? "" : "none";
            });
          });

        document
          .getElementById("searchByNameInput")
          .addEventListener("input", function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll("#orderTableBody tr");
            rows.forEach((row) => {
              const customerName =
                row
                  .querySelector("td:nth-child(2)")
                  ?.textContent.toLowerCase() || "";
              row.style.display = customerName.includes(filter) ? "" : "none";
            });
          });
      }

      // Main Functions
      async function loadOrders() {
        const data = await fetchOrders(currentFilters);
        orderData = data.orders;
        console.log(orderData)
        populateTable(orderData);
      }

      function redirectToAddProducts() {
        window.location.href = "{% url 'orders' %}";
      }

      function logout() {
        window.location.href = "{% url 'login' %}";
      }

      // Event Listeners
      document.addEventListener("DOMContentLoaded", function () {
        loadOrders();
        setupSearch();

        // Set today's date as default filter
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fromDate").value = today;
        document.getElementById("toDate").value = today;
        currentFilters.fromDate = today;
        currentFilters.toDate = today;
        loadOrders();

        const userId = localStorage.getItem("user_id") || "Guest";
        const clientId = localStorage.getItem("client_id") || "CLIENT_001";
        document.getElementById('loginInfo').innerText = `ID:${clientId} | USERID: ${userId}`;


        // Date range form handlers
        const dateRangeForm = document.getElementById("dateRangeForm");
        if (dateRangeForm) {
          dateRangeForm.addEventListener("submit", function (e) {
            e.preventDefault();
            applyDateFilter();
          });
        }
        const clearDateBtn = document.getElementById("clearDateBtn");
        if (clearDateBtn) {
          clearDateBtn.addEventListener("click", function () {
            clearDateFilter();
          });
        }

        // Modal close handlers
        const modal = document.getElementById("orderHistoryModal");
        const closeBtn = document.querySelector(".close-modal");
        if (closeBtn) closeBtn.onclick = closeModal;
        window.onclick = (e) => {
          if (e.target === modal) closeModal();
        };
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        // Add Products button
        document
          .getElementById("addProductsFromModal")
          .addEventListener("click", function () {
            if (currentOrderDetails) {
              // Store current order info for editing
              localStorage.setItem(
                "editing_order",
                JSON.stringify(currentOrderDetails)
              );
              window.location.href = "{% url 'orders' %}?mode=edit";
            } else {
              window.location.href = "{% url 'orders' %}";
            }
          });
      });
    </script>
  </body>
</html>
